#!/usr/bin/env python

import click
import yaml
from enum import IntEnum
import ldap

from ldap_connection import LDAPConnection


src_ldap = None
dst_ldap = None
verbose_level = 0


class VerboseLevel(IntEnum):
    """
    Defining the meaning of verbose levels.
    """
    ERROR = 0
    WARNING = 1
    INFO = 2
    DEBUG = 3


class ConfigItemNotFound(Exception):
    """A configuration item could not be found."""
    def __init__(self, config_item):
        self.config_item = config_item


def dn2rdns(dn):
    rdns = {}
    r = ldap.dn.str2dn(dn)
    for rdn in r:
        (a, v, t) = rdn[0]
        rdns.setdefault(a, []).append(v)
    return rdns


def get_value_from_config(config, *keys):
    """
    Get the value that belongs to the keys combination from the config file.
    This function is called recursively until either the key path delivers a
    value, or the key path is invalid, in which case the ConfigItemNotFound
    exception is raised. Otherwise the found value is returned.
    """

    try:
        if len(keys) == 1:
            return config[keys[0]]
        else:
            return get_value_from_config(config[keys[0]], *keys[1:])
    except KeyError:
        raise ConfigItemNotFound(keys[0])
    except ConfigItemNotFound as e:
        config_item = f'{keys[0]}/{e.config_item}'
        raise ConfigItemNotFound(config_item)


def get_rdn(dn, index=0):
    l = dn.split(',')
    try:
        k, v = dn.split(',')[index].split('=')
        return f'{k}={v}'
    except IndexError as e:
        print(e)


def drop_attributes(config, entry):
    for drop_attribute in config['drop_attribute']:
        try:
            if type(drop_attribute) is list:
                tmp = drop_attribute.copy()
                k = tmp.pop(0)
                for l in tmp:
                    try:
                        entry[k].remove(l)
                    except ValueError as e:
                        pass
            else:
                del entry[drop_attribute]
        except KeyError as e:
            print(f"Trying to remove non exsting key: {e} Please check configuration.")
    return entry


def copy_rdn(config, src_dn, dst_dn):
    if type(config) is list:
        for l in config:
            copy_rdn(l, src_dn, dst_dn)

    rdn = config['rdn']
    r = src_ldap.find(src_dn, f'({rdn})', None, ldap.SCOPE_ONELEVEL)
    for dn, entry in r.items():
        if 'drop_attribute' in config:
            entry = drop_attributes(config, entry)

        rdn = get_rdn(dn)
        target_dn = f'{rdn},{dst_dn}'
        dst_ldap.add_or_modify(target_dn, entry)

        if 'copy_rdn' in config:
            copy_rdn(config['copy_rdn'], f'{rdn},{src_dn}', f'{rdn},{dst_dn}')


def sync_ldap(sync_config):
    try:
        copy_rdn(sync_config['copy_rdn'], src_ldap.basedn, dst_ldap.basedn)
    except KeyError as e:
        print(f'Error in sync section of config file. Key not found: {e}')


@click.command()
@click.option('-v', '--verbose', help=f'Set verbosity level.', count=True)
@click.argument('config_filename', type=click.Path(exists=True))
@click.version_option(version='2020-08-12')
def main(config_filename, verbose):
    global src_ldap, dst_ldap

    with open(config_filename, 'r') as fd:
        config = yaml.safe_load(fd)

    try:
        src_ldap = LDAPConnection(
                get_value_from_config(config, 'ldap', 'src'),
                get_value_from_config(config, 'ldap', 'src', 'name')
                )
        dst_ldap = LDAPConnection(
                get_value_from_config(config, 'ldap', 'dst'),
                get_value_from_config(config, 'ldap', 'src', 'name')
                )

        entry = {}
        entry['objectClass'] = ['organizationalUnit']
        entry['ou'] = ['test']

        sync_ldap(get_value_from_config(config, 'sync'))
    except ConfigItemNotFound as e:
        print(f'Config error: key \'{e.config_item}\' does not exist in config file \'{config_filename}\'.')


if __name__ == "__main__":
    main()
